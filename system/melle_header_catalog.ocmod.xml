<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>melle_header_catalog</name>
    <code>melle_header_catalog</code>
    <description>Melle Header [Catalog]</description>
    <version>1.0.0</version>
    <author>PRO Hamster</author>
    <link>http://prohamster.com</link>

    <file path="catalog/controller/common/header.php">
        <operation error="skip">
            <search><![CDATA[$data['title'] = $this->document->getTitle();]]></search>
            <add position="before"><![CDATA[
                /* IVAN MOD START */
                $this->load->model('tool/base');

                $data['pagetype'] = $this->model_tool_base->getPageType();

                $data['og'] = array();
                $data['og']['image'] = $this->model_tool_base->getOgImage();

                $header_state = $this->load->controller('extension/module/melle/initHeader');
                $data['rhc'] = $this->load->controller('extension/module/melle/renderHeaderContent', $header_state);

                $this->load->controller('extension/module/melle/initCart');

                $data['melle_mobile_menu'] = $this->load->controller('extension/module/melle/getMobileMenu');

                // STATES
                $data['states'] = $this->document->getStates();

                // SUCCESS DATA
                $data['success_data'] = false;

                if ($data['pagetype'] == 'checkout-success' && isset($this->session->data['sp_order_id'])) {
                    $data['success_data'] = array();
                    $data['success_data']['order_id'] = $this->session->data['sp_order_id'];
                    unset($this->session->data['sp_order_id']);

                    $this->load->model('checkout/order');

                    $total = 0;
                    foreach ($this->model_checkout_order->getOrderTotals($data['success_data']['order_id']) as $t) {
                        if (strcmp($t['code'], 'total') === 0) {
                            $total = $t['value'];
                        }
                    }

                    $data['success_data']['total'] = number_format($total, 2, '.', '');

                    $order_offers = array();
                    foreach ($this->model_checkout_order->getOrderProducts($data['success_data']['order_id']) as $p) {
                        $order_offers[] = array(
                            'url' => $this->url->link('product/product', 'product_id=' . (int)$p['product_id']),
                            'name' => (string)$p['name'],
                            'price' => (float)$p['price'],
                            'count' => (int)$p['quantity'],
                            'currency' => 'RUB',
                        );
                    }

                    $data['success_data']['order_offers'] = json_encode($order_offers);
                }

                /* IVAN MOD END */
            ]]></add>
        </operation>
    </file>

</modification>