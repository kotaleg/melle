<modification>
    <name><![CDATA[<font color="#0000"><b>DISCOUNT SALES PRO</font>]]></name>
    <code>discountsales</code>
    <version><![CDATA[<b>1.9</b>]]></version>
    <author><![CDATA[OCEXT]]></author>
    <link>www.ocext.com</link>

    <file path="system/library/cart/cart.php">

        <operation>
            <search><![CDATA[private $data = array();]]></search>
            <add position="after"><![CDATA[
                /* DISCOUNT SALES */
                private $registry;
                /* DISCOUNT SALES */
            ]]></add>
        </operation>

        <operation>
            <search><![CDATA[$this->weight = $registry->get('weight');]]></search>
            <add position="after"><![CDATA[
                /* DISCOUNT SALES */
                $this->registry = $registry;
                /* DISCOUNT SALES */
            ]]></add>
        </operation>

        <operation>
            <search><![CDATA[public function getProducts() {]]></search>
            <add position="before"><![CDATA[
            /* DISCOUNT SALES */
            public function __get($name)
            {
                return $this->registry->get($name);
            }
            /* DISCOUNT SALES */
            ]]></add>
        </operation>

        <!-- <operation>
            <search><![CDATA[return $product_data;]]></search>
            <add position="before"><![CDATA[
                /* DISCOUNT SALES */
                if ((in_array(__FUNCTION__, array('getProducts')))) {
                    $this->load->model('extension/total/discountsales');

                    foreach ($product_data as $pd_key => $pd) {
                        $ds_data = $this->model_extension_total_discountsales->setNewPrice(
                            $pd['product_id'], $pd['price'], 0, json_decode($pd['ds_cart_option']), $pd['quantity']);
                        if (isset($ds_data['price']) ) {
                            $product_data[$pd_key]['price'] = $ds_data['price'];
                            $product_data[$pd_key]['total'] = $ds_data['price'] * $pd['quantity'];
                        }
                    }
                }
                /* DISCOUNT SALES */
            ]]></add>
        </operation> -->

        <operation>
            <search><![CDATA['cart_id'         => $cart['cart_id'],]]></search>
            <add position="before"><![CDATA[
                /* DISCOUNT SALES */
                'ds_price'          => $price,
                'ds_option_price'   => $option_price,
                'ds_cart_option'    => $cart['option'],
                'ds_quantity'       => $cart['quantity'],
                /* DISCOUNT SALES */
            ]]></add>
        </operation>

    </file>

    <!-- <file path="catalog/controller/common/header.php">
        <operation>
            <search><![CDATA[$data['title'] = $this->document->getTitle();]]></search>
            <add position="after"><![CDATA[
                $this->document->addScript('catalog/view/javascript/discountsales.js');
                $this->document->addStyle('catalog/view/theme/default/stylesheet/discountsales.css');
            ]]></add>
        </operation>
    </file> -->

    <file path="catalog/model/catalog/product.php">
        <operation>
            <search><![CDATA[class ModelCatalogProduct extends Model {]]></search>
            <add position="after"><![CDATA[

            /* DISCOUNT SALES */
            public function getSpecialPriceWhisDiscountsDiscountsales($product_id,$special) {
                $this->load->model('extension/total/discountsales');
                $discountsales_promo = $this->config->get('discountsales_promo');
                if(isset($discountsales_promo['to_product']['status']) && !$discountsales_promo['to_product']['status'] && isset($this->request->get['product_id'])){
                    return $special;
                }
                $price_whis_discount = $this->model_extension_total_discountsales->getDiscountInfo($product_id,TRUE);
                if($price_whis_discount && is_object($price_whis_discount)){

                    foreach ($price_whis_discount as $key => $value) {
                        //var_dump($value);
                        if(!is_array($value)){
                            if(!isset($new_special)){
                                $new_special = $value->total_price;
                            }
                            $new_special += $value->value;
                        }
                        //категории, там нужно суммировать все скидки, если товар в нескольких и по ним также скидка
                        elseif(is_array($value)){
                            foreach ($value as $category_id => $value_category) {
                                if(!isset($new_special)){
                                    $new_special = $value_category->total_price;
                                }
                                $new_special += $value_category->value;
                            }
                        }
                    }
                }
                if(isset($new_special) && $special && $new_special<=$special && $new_special>0){
                    return $new_special;
                }elseif(isset($new_special) && !$special && $new_special>0){
                    return $new_special;
                }else{
                    return $special;
                }
            }
            /* DISCOUNT SALES */
            ]]></add>
        </operation>

        <operation>
            <search><![CDATA['special'          => $query->row['special'],]]></search>
            <add position="after"><![CDATA[
                /* DISCOUNT SALES */
                'special'          => $this->getSpecialPriceWhisDiscountsDiscountsales($product_id, $query->row['special']),
                /* DISCOUNT SALES */
            ]]></add>
        </operation>
    </file>
</modification>