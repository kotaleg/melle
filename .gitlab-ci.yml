image: ubuntu:18.04

before_script:
  - apt-get update && apt-get install -y --no-install-recommends -qq apt-utils
  - apt-get install -qq curl
  - apt-get install -qq gnupg
  - apt-get install -qq gnupg1
  - apt-get install -qq gnupg2
  - apt-get install -qq zip unzip
  - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
  - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
  - apt-get update -qq
  - apt-get install -y -qq sshpass
  - apt-get install -y -qq nodejs
  - nodejs --version
  - apt-get install -y -qq npm
  - npm --version
  - apt-get install -y -qq yarn
  - yarn --version

deploy_stage:
  stage: deploy
  environment: Staging
  only:
    - master
  script:
    # CLEAR
    - rm ./API ./PLAN ./MOVE.todo ./melle-new.sublime-project ./.gitignore ./.gitlab-ci.yml -f
    - rm -Rf ./.git

    # CONFIG FILES
    - rm ./config.php ./admin/config.php
    - mv ./config.work.php ./config.php
    - mv ./admin/config.work.php ./admin/config.php

    # YARN RUN
    - rm -f ./yarn.lock ./mix-manifest.json
    - yarn install
    - yarn run prod
    - yarn run prod-import1c
    - yarn run prod-offersadmin
    - yarn run prod-offers

    # CLEAR AFTER YARN
    - rm -Rf ./node_modules/
    - rm -f ./yarn.lock
    - rm -f ./package.json
    - rm -f ./webpack*
    - rm -Rf ./catalog/view/javascript/melle/src/
    - rm -Rf ./admin/view/javascript/import_1c/src/
    - rm -Rf ./admin/view/javascript/super_offers/src/
    - rm -Rf ./admin/view/javascript/super_offers_admin/src/

    # CLONE TO PROD
    - sshpass -V
    - export SSHPASS=$K8S_SECRET_SSH
    - sshpass -e ssh -o stricthostkeychecking=no web@91.226.80.187 "bash -s" < ./build/backup.sh
    - rm -Rf ./build/
    - zip -r foo.zip .
    - sshpass -e scp -o stricthostkeychecking=no -r ./foo.zip web@91.226.80.187:/home/web/work.melle.online/www
    - sshpass -e ssh -o stricthostkeychecking=no web@91.226.80.187 "unzip /home/web/work.melle.online/www/foo.zip -d /home/web/work.melle.online/www/"
    - sshpass -e ssh -o stricthostkeychecking=no web@91.226.80.187 "rm /home/web/work.melle.online/www/foo.zip -f"