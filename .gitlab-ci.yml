image: ubuntu:18.04

# cache:
#   paths:
#     - node_modules/

before_script:
  - apt-get update && apt-get install -y --no-install-recommends apt-utils -qq
  - apt-get install curl -qq
  - apt-get install gnupg -qq
  - apt-get install gnupg1 -qq
  - apt-get install gnupg2 -qq
  - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
  - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
  - apt-get update -qq
  - apt-get install -y sshpass -qq
  - apt-get install nodejs -qq
  - apt-get install npm -qq
  - apt-get install -y yarn -qq
  - yarn --version

deploy_stage:
  stage: deploy
  environment: Staging
  only:
    - master
  script:
    # CLEAR OPENCART
    - rm ./API ./PLAN ./MOVE.todo ./melle-new.sublime-project ./get_url.js ./get_url_pvz.js

    # YARN RUN
    - rm ./yarn.lock ./mix-manifest.json
    - yarn install
    - yarn run prod
    - yarn run prod-import1c
    - yarn run prod-offersadmin
    - yarn run prod-offers

    # CLEAR AFTER YARN
    - rm ./yarn.lock ./mix-manifest.json
    - rm ./package.json
    - rm ./webpack*
    - rm ./catalog/view/javascript/melle/src/
    - rm ./admin/view/javascript/import_1c/src/
    - rm ./admin/view/javascript/super_offers/src/
    - rm ./admin/view/javascript/super_offers_admin/src/